<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
    body { 
        background:#0b111f; 
        color:white; 
        font-family:Arial; 
        margin:0;
        padding:20px;
    }
    table { 
        width:100%; 
        border-collapse:collapse; 
        margin-top:20px; 
    }
    td, th { 
        border:1px solid #333; 
        padding:10px; 
        text-align:left; 
    }
    button { 
        padding:6px 12px; 
        background:#ff4444; 
        border:none; 
        cursor:pointer; 
        border-radius:6px; 
        color:#000;
        font-weight:bold;
    }
    button:hover { 
        background:#cc0000; 
    }

    /* ====== CUSTOM CONFIRM MODAL ====== */
    #confirmModal {
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.7);
        justify-content:center;
        align-items:center;
        z-index:9999;
    }
    #confirmModal.show {
        display:flex;
    }
    #confirmBox {
        background:#121a2b;
        padding:25px;
        border-radius:10px;
        width:300px;
        text-align:center;
        border:1px solid #4da6ff;
        box-shadow:0 0 15px rgba(0,0,0,0.5);
    }
    #confirmBox h3 {
        margin-bottom:10px;
        color:#4da6ff;
    }
    #confirmBox p {
        margin-bottom:20px;
    }
    .btn {
        padding:8px 16px;
        border-radius:6px;
        border:none;
        cursor:pointer;
        font-weight:bold;
    }
    .btn-danger {
        background:#ff4444;
        color:black;
    }
    .btn-danger:hover {
        background:#cc0000;
    }
    .btn-secondary {
        background:#4da6ff;
        color:black;
        margin-left:10px;
    }
    .btn-secondary:hover {
        background:#337acc;
    }
</style>
</head>
<body>

<h1>Admin Panel</h1>
<div id="loading">Betöltés...</div>

<table id="userTable" style="display:none;">
    <thead>
        <tr>
            <th>ID</th>
            <th>Felhasználónév</th>
            <th>Email</th>
            <th>Szerepkör</th>
            <th>Profilkép</th>
            <th>Művelet</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- ===== CUSTOM CONFIRM MODAL ===== -->
<div id="confirmModal">
    <div id="confirmBox">
        <h3>Biztos törlöd?</h3>
        <p>Ez a művelet nem visszavonható.</p>
        <button id="confirmYes" class="btn btn-danger">Igen, töröld</button>
        <button id="confirmNo" class="btn btn-secondary">Mégse</button>
    </div>
</div>

<script>
let token = localStorage.getItem("token");

if (!token) {
    alert("Nincs admin token, jelentkezz be újra!");
    window.location.href = "account1.html";
}

// (opcionális) JWT ellenőrzés, hogy tényleg admin-e
try {
    let payload = JSON.parse(atob(token.split('.')[1]));
    if (!payload.data || payload.data.role !== "admin") {
        alert("Nincs admin jogosultságod!");
        window.location.href = "account1.html";
    }
} catch (e) {
    alert("Hibás token. Jelentkezz be újra!");
    window.location.href = "account1.html";
}

// ===== FELHASZNÁLÓK LEKÉRÉSE =====
fetch("Admin_dashboard.php?action=list", {
    headers: { "Authorization": "Bearer " + token }
})
.then(r => r.json())
.then(data => {
    if (data.error) {
        alert("Hiba: " + data.error);
        return;
    }

    document.getElementById("loading").style.display = "none";
    const table = document.getElementById("userTable");
    table.style.display = "table";

    let tbody = table.querySelector("tbody");
    tbody.innerHTML = "";

    data.forEach(u => {
        // ha a backend valamiért mégis visszaküldi az admint, itt is kiszűrjük
        if (u.role === "admin") return;

        let row = `
            <tr>
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>${u.email}</td>
                <td>${u.role}</td>
                <td><img src="${u.profile_pic}" width="40" height="40" style="border-radius:50%"></td>
                <td><button onclick="openConfirm(${u.id})">Törlés</button></td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
});

// ===== CUSTOM CONFIRM LOGIKA =====
let pendingDeleteId = null;

function openConfirm(id) {
    pendingDeleteId = id;
    document.getElementById("confirmModal").classList.add("show");
}

function closeConfirm() {
    document.getElementById("confirmModal").classList.remove("show");
    pendingDeleteId = null;
}

document.getElementById("confirmYes").addEventListener("click", function () {
    if (pendingDeleteId !== null) {
        deleteUserConfirmed(pendingDeleteId);
    }
    closeConfirm();
});

document.getElementById("confirmNo").addEventListener("click", function () {
    closeConfirm();
});

// ===== TÖRLÉS – CSAK A MODAL HÍVJA =====
function deleteUserConfirmed(id) {
    fetch("Admin_dashboard.php?action=delete&id=" + id, {
        headers: { "Authorization": "Bearer " + token }
    })
    .then(r => r.json())
    .then(d => {
        alert(d.message || d.error);
        location.reload();
    });
}
</script>

</body>
</html>
