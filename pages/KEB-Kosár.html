<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Kosár - KEB hangszerbolt</title>
  <link rel="icon" href="../uploads/favicon-16x16.png">



  <link rel="stylesheet" href="../assets/css/Mobile.css">
  <link rel="stylesheet" href="../assets/css/kosar.css">

  <!-- Light theme -->
  <link rel="stylesheet" href="../assets/css/LightTheme.css">

  <!-- Popup + Toast CSS -->
  <link rel="stylesheet" href="../assets/css/warningtoast.css">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="cart-page bg-dark text-light" >
<div class="lang-switch" role="group" aria-label="Nyelv">
  <button type="button" class="lang-pill" data-lang="hu">HU</button>
  <button type="button" class="lang-pill" data-lang="en">EN</button>
  <button type="button" class="lang-pill" data-lang="de">DE</button>
</div>

<!-- TOAST GYÁKÁR -->
<div id="cart-toast-root"></div>

<div class="cart-toolbar">
  <button id="vissza" class="btn btn-outline-info" data-i18n="back_home">← Vissza a főoldalra</button>
  <div class="cart-title">
    <h1 data-i18n="cart_title">Kosarad</h1>
    <p data-i18n="cart_sub">Rendezd a mennyiségeket, majd lépj tovább a Fizetéshez.</p>
  </div>
  <button id="szallitas" class="btn btn-outline-info" data-i18n="shipping_options">Szállítás opciók</button>
</div>

<main class="cart-grid">
  <section class="cart-panel">
  <table class="table table-dark table-hover table-bordered rounded-3 overflow-hidden cart-table">
    <thead class="table-info text-center">
      <tr>
        <th data-i18n="cart_product">Termék</th>
        <th data-i18n="cart_price">Ár (Ft)</th>
        <th data-i18n="cart_qty">mennyiség</th>
        <th data-i18n="cart_total">Összesen (Ft)</th>
      </tr>
    </thead>
    <tbody id="kosarLista"></tbody>
  </table>
  </section>

  <aside class="cart-panel cart-summary">
    <p id="osszeg" class="fs-4 fw-bold text-info"></p>
    <button id="uresites" class="btn btn-outline-danger w-100" data-i18n="cart_clear">Kosár törlése</button>

    <div id="fizetesGomb" class="mt-3" style="display: none;">
      <button id="fizetesBtn" class="btn btn-success w-100">
        <span data-i18n="pay">Fizetés</span>
      </button>
      <button id="orderBtn" class="btn btn-primary w-100 mt-2" data-i18n="order_btn">Rendelés</button>
    </div>
  </aside>
</main>

<!-- POPUP � Kosár törlése -->
<div id="deleteModal" class="modal-overlay">
  <div class="modal-box">
    <h3 data-i18n="cart_confirm_title">Biztosan töröld a kosarat?</h3>
    <p data-i18n="cart_confirm_desc">Minden Termék el fog tűnni.</p>

    <div class="modal-buttons">
      <button id="cancelDelete" class="btn-cancel" data-i18n="cancel">Mégse</button>
      <button id="confirmDelete" class="btn-delete" data-i18n="delete">törlés</button>
    </div>
  </div>
</div>

<script src="../assets/js/lang.js"></script>

<script>
const tr = (key, fallback) =>
  window.SH_LANG && window.SH_LANG.t ? window.SH_LANG.t(key) : (fallback || key);
/* ================================
   TOAST FUNKCIA?
================================ */
function showToast(uzenet) {
  const root = document.getElementById("cart-toast-root");
  const toast = document.createElement("div");

  toast.className = "cart-toast";
  toast.innerHTML = uzenet;

  root.appendChild(toast);

  setTimeout(() => toast.classList.add("show"), 10);
  setTimeout(() => toast.classList.add("hide"), 2000);
  setTimeout(() => toast.remove(), 2500);
}

/* ================================
   Kosár BEÁLLÍTÁSA
================================ */
function betoltKosar() {
  const kosar = JSON.parse(localStorage.getItem("kosar")) || [];
  const lista = document.getElementById("kosarLista");
  const fizetesDiv = document.getElementById("fizetesGomb");
  lista.innerHTML = "";

  let total = 0;

  kosar.forEach((item, index) => {
    const osszeg = item.ar * (item.db || 1);
    total += osszeg;

    const sor = document.createElement("tr");
    sor.innerHTML = `
      <td>${item.nev}</td>
      <td>${item.ar.toLocaleString()}</td>
      <td>
        <input 
          type="number" 
          min="0" 
          value="${item.db || 1}" 
          class="form-control bg-primary-subtle text-light text-center rounded-pill cart-qty"
          onchange="mennyisegValtozas(${index}, this.value)">
      </td>
      <td>${osszeg.toLocaleString()}</td>
    `;
    lista.appendChild(sor);
  });

  document.getElementById("osszeg").textContent =
    tr("cart_total") + ": " + total.toLocaleString() + " Ft";

  // Fizetés gomb megjelenítése / elrejtése
  if (kosar.length > 0) {
    fizetesDiv.style.display = "block";
  } else {
    fizetesDiv.style.display = "none";
  }
}

/* ================================
   mennyiség MÓDOSÍTÁS
================================ */
function mennyisegValtozas(index, uj) {
  let kosar = JSON.parse(localStorage.getItem("kosar")) || [];
  uj = parseInt(uj);

  if (uj <= 0) kosar.splice(index, 1);
  else kosar[index].db = uj;

  localStorage.setItem("kosar", JSON.stringify(kosar));
  betoltKosar();
}

/* ================================
   POPUP MŰKÖDÉSE
================================ */
const modal = document.getElementById("deleteModal");
const cancelBtn = document.getElementById("cancelDelete");
const confirmBtn = document.getElementById("confirmDelete");

document.getElementById("uresites").onclick = () => {
  modal.classList.add("show");
};

cancelBtn.onclick = () => modal.classList.remove("show");

// törlés - Kosár törlése + toast
confirmBtn.onclick = () => {
  localStorage.removeItem("kosar");
  betoltKosar();
  modal.classList.remove("show");
  showToast(tr("cart_deleted"));
};

/* ================================
   VISSZA & SZÁLLÍTÁS GOMB
================================ */
document.getElementById("vissza").onclick = () => {
  window.location.href = "KEBhangszerek.html";
};

document.getElementById("szallitas").onclick = () => {
  window.location.href = "szallitas.html";
};

/* ================================
   Fizetés GOMB
================================ */
document.getElementById("fizetesBtn").onclick = () => {
  window.location.href = "fizetes.html";
};

/* ================================
   INIT
================================ */
betoltKosar();

// ================================
//   RENDELES GOMB
// ================================
document.getElementById("orderBtn").onclick = async () => {
  const token = localStorage.getItem("token");
  if (!token) {
    showToast("Bejelentkezés szükséges a rendeléshez!");
    return;
  }
  const kosar = JSON.parse(localStorage.getItem("kosar")) || [];
  if (kosar.length === 0) {
    showToast("A kosár üres!");
    return;
  }

  const res = await fetch("../server/create_order.php", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ items: kosar })
  });

  let data = {};
  try { data = await res.json(); } catch { data = {}; }

  if (!res.ok) {
    showToast((data.error || "Rendelés sikertelen") + (data.detail ? (": " + data.detail) : ""));
    return;
  }

  localStorage.removeItem("kosar");
  betoltKosar();
  showToast("Rendelés r?gz?tve!" );
};
</script>
<script src="../assets/js/DarkLight.js"></script>
</body>
</html>



